steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(python.version)
      addToPath: true
      architecture: 'x64'
    condition: ne( variables['Agent.OS'], 'Windows_NT' )

  - script: |
      python -c "import sys; print(sys.version)"
      python -c "from urllib2 import urlopen; u = urlopen('https://bootstrap.pypa.io/get-pip.py');open('get-pip.py', 'w').write(u.read().decode('utf-8'))"
      python get-pip.py
    displayName: 'Install pip (on Windows)'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )

  - script: |
      python -m pip install --upgrade pip setuptools wheel
      python -m pip install numpy cython --user
    displayName: 'Install basic Python tools'

  - script: python -m pip install brian2 nose matplotlib ipython --user
    displayName: 'Install Brian2 and dependencies'

  - script: python -m pip install --no-deps --ignore-installed --user .
    displayName: 'Install Brian2GeNN'

  - bash: |
      git clone --depth=1 https://github.com/genn-team/genn.git ../genn
      cd ../genn
      latestTag=$(git describe --tags `git rev-list --tags --max-count=1`)
      git checkout $latestTag
    displayName: 'Install GeNN'

  # Linux + OS X
  - bash: |
      export GENN_PATH=$(python -c "import os; print(os.path.realpath('../genn'))")
      cd ..  # move out of the source directory to avoid direct import
      python -c 'from brian2 import *;import brian2genn;set_device("genn", with_output=True, use_GPU=False, debug=True);group = NeuronGroup(5, "dv/dt = -v/(10*ms) : 1");run(1*ms)'
    displayName: 'Run tests'
    condition: ne( variables['Agent.OS'], 'Windows_NT' )
  # Windows
  - script: |
      set SOURCE_DIR=%CD%
      cd ..
      set GENN_PATH=%CD%\genn
      python %SOURCE_DIR%\simple_test.py
    displayName: 'Run tests'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )